---
phase: 03-foundation-hardening
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - test/exec.test.js
  - test/conversation-store.test.js
  - test/decision-executor.test.js
  - test/helpers.js
autonomous: true

must_haves:
  truths:
    - "Running `node --test test/` executes tests and they all pass"
    - "Tests verify core orchestrator behavior without shelling out to real claude -p"
    - "The exec.js wrapper can be mocked to return canned responses"
    - "Tests use temp directories that are cleaned up after each test"
  artifacts:
    - path: "test/helpers.js"
      provides: "Test utilities: temp dir helper, mock exec factory, fixture builder"
      exports: ["createTempDir", "mockClaudeP", "createMockDeps"]
      min_lines: 30
    - path: "test/exec.test.js"
      provides: "Tests for lib/exec.js semaphore and claudeP behavior"
      min_lines: 40
    - path: "test/conversation-store.test.js"
      provides: "Tests for conversation persistence, TTL, cap, credential filtering"
      min_lines: 40
    - path: "test/decision-executor.test.js"
      provides: "Tests for recommendation dedup, evaluate(), and formatForSMS()"
      min_lines: 40
  key_links:
    - from: "test/exec.test.js"
      to: "lib/exec.js"
      via: "require and test ClaudeSemaphore directly"
      pattern: "require.*exec"
    - from: "test/helpers.js"
      to: "lib/exec.js"
      via: "mock factory that replaces claudeP"
      pattern: "claudeP|mockClaudeP"
---

<objective>
Create the test infrastructure using Node.js built-in `node:test` runner and write integration tests for the three core modules built in Plans 01-02: exec.js (semaphore), conversation-store.js (persistence), and decision-executor.js (dedup).

Purpose: FOUND-05 requires test infrastructure. These are the first tests in the project. They establish patterns (helpers, mocking, temp dirs) that all future tests will follow. Testing the three new modules from this phase proves the foundation works before building on it.

Output: `test/` directory with helpers.js, and 3 test files covering exec, conversation-store, and decision-executor. `node --test test/` passes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/exec.js
@lib/conversation-store.js
@lib/decision-executor.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test/helpers.js and test/exec.test.js</name>
  <files>test/helpers.js, test/exec.test.js</files>
  <action>
1. **Create test/helpers.js:**
   - Use `const { describe, it, before, after, beforeEach, afterEach } = require('node:test');` and `const assert = require('node:assert');` pattern.
   - Export helper functions:

   a. `createTempDir(prefix='orch-test-')`:
      - Creates a temp directory under `os.tmpdir()` using `fs.mkdtempSync`
      - Returns `{ dir, cleanup }` where cleanup removes the directory recursively
      - Use `fs.rmSync(dir, { recursive: true, force: true })` for cleanup

   b. `mockClaudeP(responses)`:
      - Takes an array of canned response strings (or functions that return strings)
      - Returns a function with the same signature as `claudeP(prompt, options)`
      - Each call consumes the next response from the array
      - If array is exhausted, throws an error "No more mock responses"
      - Tracks calls: returned function has `.calls` array with `{ prompt, options }` for each invocation
      - Example usage: `const mock = mockClaudeP(['{"recommendations":[],"summary":"ok"}']); mock('test prompt', {model:'sonnet'}); assert.equal(mock.calls.length, 1);`

   c. `createMockDeps(overrides={})`:
      - Returns a standard dependency object for constructing CommandRouter, AIBrain, etc.:
        ```js
        {
          scanner: { scanAll: () => [], scanProject: () => null },
          processMonitor: { checkProjects: () => ({}) },
          digest: { formatMorningDigest: () => '', formatProjectDetail: () => '' },
          scheduler: { isQuietTime: () => false },
          sessionManager: { getActiveSessions: () => [], getSessionStatuses: () => [], startSession: () => ({success:true,message:'started'}), stopSession: () => ({success:true,message:'stopped'}) },
          signalProtocol: { injectClaudeMd: () => {}, clearSignal: () => {} },
          state: { load: () => ({aiDecisionHistory:[],executionHistory:[],runtimeAutonomyLevel:'observe'}), save: () => {}, getAutonomyLevel: () => 'observe', logDecision: () => {}, logExecution: () => {} },
          messenger: { send: () => {} },
          config: { ai: { enabled: true, model: 'sonnet', autonomyLevel: 'observe' }, projects: [] },
          projectNames: [],
          ...overrides
        }
        ```

2. **Create test/exec.test.js:**
   Test the ClaudeSemaphore class (NOT the actual claude -p execution -- that would require the CLI):

   a. `test('ClaudeSemaphore: allows up to maxConcurrent simultaneous acquires')`:
      - Create semaphore with max=2
      - Acquire twice -- both should resolve immediately
      - Assert active === 2, pending === 0
      - Release both

   b. `test('ClaudeSemaphore: third acquire waits until release')`:
      - Create semaphore with max=2
      - Acquire twice
      - Start a third acquire (do NOT await yet) -- save the promise
      - Assert pending === 1
      - Release one slot
      - Await the third promise -- should now resolve
      - Assert active === 2, pending === 0
      - Release all

   c. `test('ClaudeSemaphore: release resolves waiters in FIFO order')`:
      - Create semaphore with max=1
      - Acquire once
      - Start two more acquires (promise A, promise B) in order
      - Release one -- promise A should resolve first
      - Release one -- promise B should resolve
      - Verify order via side effects (push to array on resolution)

   d. `test('claudeP: builds correct command flags')`:
      - This tests command construction WITHOUT executing. Use a mock approach:
      - Temporarily monkey-patch `child_process.execSync` in the test to capture the command string and return a fake result
      - OR: just test that the module exports the expected functions and the semaphore instance exists
      - Simplest approach: verify exports exist and types are correct

   Use `const { describe, it } = require('node:test')` and `const assert = require('node:assert/strict')`.
  </action>
  <verify>
    - `node --test test/exec.test.js` -- all tests pass
    - `node -e "const h = require('./test/helpers'); console.log(typeof h.createTempDir, typeof h.mockClaudeP, typeof h.createMockDeps)"` -- prints "function function function"
  </verify>
  <done>test/helpers.js provides createTempDir, mockClaudeP, createMockDeps. test/exec.test.js tests the ClaudeSemaphore with 3-4 tests covering concurrency limiting, wait queueing, and FIFO ordering. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create test/conversation-store.test.js and test/decision-executor.test.js</name>
  <files>test/conversation-store.test.js, test/decision-executor.test.js</files>
  <action>
1. **Create test/conversation-store.test.js:**
   Tests for the ConversationStore from Plan 02.

   a. `test('persists messages to disk and loads them back')`:
      - Create a store with a temp file path
      - Push 3 messages
      - Create a NEW store instance with the same file path
      - getAll() should return the same 3 messages

   b. `test('enforces maxMessages cap')`:
      - Create store with maxMessages=3
      - Push 5 messages
      - getAll() returns only the 3 newest

   c. `test('prunes messages older than TTL')`:
      - Create store with ttlMs=1000 (1 second)
      - Push a message with ts = Date.now() - 2000 (2 seconds ago)
      - Push a message with ts = Date.now() (now)
      - getAll() returns only the recent message

   d. `test('filters credential patterns')`:
      - Push messages containing:
        - `"my key is sk-abc123def456ghi789012345"` (OpenAI-style)
        - `"token: ghp_abcdef1234567890abcdef1234567890abcd"` (GitHub PAT)
        - `"stripe sk_live_abcdef123456"` (Stripe key)
      - Verify each stored message contains `[REDACTED]` instead of the secret
      - Verify non-secret text is preserved

   e. `test('clear() removes all messages')`:
      - Push messages, call clear(), getAll() returns empty array

   Use temp directories for file paths. Clean up in afterEach.

2. **Create test/decision-executor.test.js:**
   Tests for the dedup functionality from Plan 02.

   a. `test('evaluate: validates recommendations against allowlist')`:
      - Create DecisionExecutor with mock deps
      - Evaluate a rec with action='start' -- validated should be true
      - Evaluate a rec with action='hack' -- validated should be false, rejected='unknown action'

   b. `test('evaluate: respects protected projects')`:
      - Config has protectedProjects: ['secret-project']
      - Evaluate a rec for 'secret-project' -- rejected='protected project'

   c. `test('evaluate: marks observe mode as observeOnly')`:
      - State returns autonomyLevel='observe'
      - Evaluate a valid rec -- observeOnly should be true

   d. `test('formatForSMS: deduplicates repeated recommendations')`:
      - Create DecisionExecutor
      - Call formatForSMS with a recommendation -- should return a non-null string
      - Call formatForSMS again with the SAME recommendation -- should return null (duplicate)

   e. `test('formatForSMS: allows same recommendation after TTL expires')`:
      - Create DecisionExecutor with dedupTtlMs=100 (100ms)
      - Call formatForSMS with a recommendation
      - Wait 150ms (setTimeout + await)
      - Call formatForSMS again -- should return non-null (TTL expired, not a dup)

   f. `test('formatForSMS: different recommendations are not deduped')`:
      - Call formatForSMS with rec A (project='foo', action='start')
      - Call formatForSMS with rec B (project='bar', action='start')
      - Both should return non-null strings
  </action>
  <verify>
    - `node --test test/conversation-store.test.js` -- all tests pass
    - `node --test test/decision-executor.test.js` -- all tests pass
    - `node --test test/` -- ALL tests across all files pass
  </verify>
  <done>Integration tests cover conversation store (persistence, TTL, cap, credentials, clear) and decision executor (validation, protected projects, observe mode, dedup, TTL expiry). All tests pass with `node --test test/`.</done>
</task>

</tasks>

<verification>
1. `node --test test/` -- all tests pass with 0 failures
2. `ls test/` -- contains helpers.js, exec.test.js, conversation-store.test.js, decision-executor.test.js
3. Test count is at least 12 across all files
4. No test uses real claude -p (all use mocks or test the module's internal logic)
5. Temp files/directories are cleaned up after tests
</verification>

<success_criteria>
- `node --test test/` runs all tests and reports 0 failures
- Test infrastructure (helpers.js) provides reusable createTempDir, mockClaudeP, createMockDeps
- exec.test.js tests semaphore concurrency limiting (at least 3 tests)
- conversation-store.test.js tests persistence, TTL, cap, credential filtering (at least 4 tests)
- decision-executor.test.js tests validation, dedup, TTL expiry (at least 4 tests)
- No tests shell out to real claude -p
</success_criteria>

<output>
After completion, create `.planning/phases/03-foundation-hardening/03-04-SUMMARY.md`
</output>
