---
phase: 07-personal-assistant
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - lib/session-manager.js
  - lib/context-assembler.js
autonomous: true

must_haves:
  truths:
    - "startSession() accepts an optional mcpConfig parameter and passes --mcp-config flag to the claude CLI if provided"
    - "When mcpConfig is provided, a temporary JSON file is written to .orchestrator/mcp-config.json and referenced in the tmux launch command"
    - "_buildResumePrompt() mentions available MCP capabilities when MCP servers are configured at user scope"
    - "ContextAssembler includes session MCP capability info in the prompt section so the AI brain knows sessions have tool access"
    - "User-scope MCP servers (github, filesystem, docker-mcp, etc.) are already available to managed sessions and no extra configuration is needed for them"
    - "The --mcp-config flag is only added when project-specific MCP servers are needed beyond user scope"
  artifacts:
    - path: "lib/session-manager.js"
      provides: "MCP-aware session launching with optional --mcp-config"
      contains: "mcp-config"
    - path: "lib/context-assembler.js"
      provides: "AI context with session MCP capability awareness"
      contains: "MCP tools"
  key_links:
    - from: "lib/session-manager.js"
      to: "claude CLI"
      via: "--mcp-config flag for project-specific MCP servers"
      pattern: "mcp-config"
    - from: "lib/session-manager.js"
      to: ".orchestrator/mcp-config.json"
      via: "Temporary MCP config file written before session launch"
      pattern: "mcp-config\\.json"
---

<objective>
Configure managed Claude Code sessions with MCP server access. Since user-scope MCP servers are already available to all sessions, the main work is: (1) adding optional --mcp-config support for project-specific MCP, (2) updating session resume prompts to mention available tools, and (3) adding session MCP info to the AI brain context.

Purpose: PA-03 ensures managed sessions can leverage GitHub, filesystem, Docker, Calendar, and other MCP tools during autonomous work. The research confirmed user-scope MCP servers are already inherited by managed sessions, so this plan focuses on awareness (telling sessions what tools they have) and extensibility (project-specific MCP configs).
Output: Updated session-manager.js with MCP config support, updated context-assembler.js with session MCP awareness.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-personal-assistant/07-RESEARCH.md
@lib/session-manager.js
@lib/context-assembler.js
@lib/mcp-bridge.js
@config.json
@index.js
@test/helpers.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP config support to session-manager.js</name>
  <files>lib/session-manager.js</files>
  <action>
Two changes to SessionManager:

1. **Update startSession() to accept and apply MCP config.** Modify the method signature and tmux launch command:

Change the method signature from:
```javascript
startSession(projectName, prompt) {
```
to:
```javascript
startSession(projectName, prompt, options = {}) {
```

Where `options` can contain:
- `mcpConfig`: An object with `{ mcpServers: { ... } }` for project-specific MCP servers

After the `this._clearSignals(signalDir);` call and before the `const resumePrompt = ...` line, add:

```javascript
    // Write project-specific MCP config if provided
    let mcpConfigFlag = '';
    if (options.mcpConfig) {
      const mcpConfigPath = path.join(signalDir, 'mcp-config.json');
      fs.writeFileSync(mcpConfigPath, JSON.stringify(options.mcpConfig, null, 2));
      mcpConfigFlag = ` --mcp-config "${mcpConfigPath}"`;
    }
```

Then update the tmux launch command to include the MCP config flag. Change:
```javascript
execSync(
  `tmux new-session -d -s "${sessionName}" -c "${projectDir}" ` +
    `"claude --dangerously-skip-permissions"`,
  { timeout: 10000 }
);
```
to:
```javascript
execSync(
  `tmux new-session -d -s "${sessionName}" -c "${projectDir}" ` +
    `"claude --dangerously-skip-permissions${mcpConfigFlag}"`,
  { timeout: 10000 }
);
```

2. **Update _buildResumePrompt() to mention MCP capabilities.** After the evalContext block (after the `evalContext = parts.join(' ') + '\n\n';` line), add an MCP context line:

```javascript
    // Add MCP capability awareness
    let mcpContext = '';
    try {
      const MCPBridge = require('./mcp-bridge').MCPBridge || require('./mcp-bridge');
      if (MCPBridge.KNOWN_SERVERS) {
        const available = MCPBridge.KNOWN_SERVERS.map(s => `${s.name} (${s.description})`).join(', ');
        mcpContext = `You have MCP tool access to: ${available}. Use these tools when they would help accomplish the task.\n\n`;
      }
    } catch {} // MCPBridge may not exist yet, degrade gracefully
```

Then include `mcpContext` in both return paths of _buildResumePrompt:

For the STATE.md path:
```javascript
return (
  evalContext +
  mcpContext +
  "Resume work on this project. Read .planning/STATE.md for where we left off, " +
  "then continue with the next steps listed there. Work autonomously."
);
```

For the no-state path:
```javascript
return (
  evalContext +
  mcpContext +
  `This is the ${projectName} project. Read the existing code, README, and any docs to understand what this project does. ` +
  "Then look at git log and recent changes to understand where work left off. " +
  "Continue any in-progress work, or if everything looks done, check for bugs, missing tests, or improvements. " +
  "Work autonomously."
);
```

Do NOT:
- Change the existing 2-argument calls to startSession (the options parameter has a default)
- Remove --dangerously-skip-permissions (interactive sessions need it for autonomous operation)
- Make MCP a required dependency (graceful degradation if MCPBridge not found)
- Add --allowedTools restrictions (with --dangerously-skip-permissions, all tools are already allowed)
  </action>
  <verify>
Run `node -e "const SM = require('./lib/session-manager'); console.log(typeof SM)"` -- should print 'function'.

Run `node -e "const src = require('fs').readFileSync('./lib/session-manager.js','utf-8'); console.log(src.includes('mcpConfig'), src.includes('mcp-config'), src.includes('MCP tool access'))"` -- should print three 'true' values.
  </verify>
  <done>
SessionManager supports optional --mcp-config for project-specific MCP, and resume prompts tell sessions about available MCP tools.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add session MCP awareness to context-assembler.js</name>
  <files>lib/context-assembler.js</files>
  <action>
Update the _buildSessionsSection() method to include MCP capability info when sessions are running.

After the existing timeout warning logic in _buildSessionsSection, when listing active sessions, add a note about MCP access. Modify the _buildSessionsSection to include:

After the loop that builds session lines (after the `for (const s of sessions)` block), add:

```javascript
    // Note MCP capability for active sessions
    if (sessions.length > 0) {
      lines.push('');
      lines.push('Sessions have MCP tool access: GitHub, filesystem, Docker, Calendar, Apple (Reminders/Notes), Memory.');
    }
```

This tells the AI brain that managed sessions have tool access, so it can factor that into its decisions (e.g., recommending sessions use GitHub MCP to create PRs).

Do NOT:
- Add this to every session line (too verbose, one summary line is enough)
- Query the MCPBridge for server status (this is about session capabilities, not orchestrator capabilities)
- Change the method signature
  </action>
  <verify>
Run `node -e "
const helpers = require('./test/helpers');
const CA = require('./lib/context-assembler');
const deps = helpers.createMockDeps();
deps.sessionManager.getActiveSessions = () => [{ projectName: 'test', created: new Date().toISOString() }];
const ca = new CA(deps);
const section = ca._buildSessionsSection([{ projectName: 'test', created: new Date().toISOString() }]);
console.log(section.includes('MCP tool access'));
"` -- should print 'true'.
  </verify>
  <done>
ContextAssembler tells the AI brain that managed sessions have MCP tool access, enabling the AI to recommend tool usage in session prompts.
  </done>
</task>

</tasks>

<verification>
- `node -e "require('./lib/session-manager')"` loads without error
- `node -e "require('./lib/context-assembler')"` loads without error
- startSession() accepts 3 arguments (projectName, prompt, options) without breaking existing 2-argument callers
- Resume prompts mention MCP tool availability
- Context assembler notes MCP access for active sessions
- No new npm dependencies added
</verification>

<success_criteria>
Managed Claude Code sessions launched by the orchestrator are aware of available MCP tools (GitHub, filesystem, Docker, Calendar, etc.) via their resume prompts. Project-specific MCP configs can be passed via the options.mcpConfig parameter. The AI brain context notes that sessions have MCP access, enabling it to recommend tool-heavy approaches.
</success_criteria>

<output>
After completion, create `.planning/phases/07-personal-assistant/07-03-SUMMARY.md`
</output>
