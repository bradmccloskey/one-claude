---
phase: 04-session-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/git-tracker.js
  - lib/resource-monitor.js
autonomous: true

must_haves:
  truths:
    - "GitTracker.getProgress(dir, since) returns commit count, insertions, deletions, filesChanged, fileList, and last commit metadata"
    - "GitTracker never throws -- non-git directories return { noGit: true, commitCount: 0 }"
    - "ResourceMonitor.getSnapshot() returns CPU load, memory, disk usage, and uptime"
    - "ResourceMonitor.formatForContext(snapshot) returns a single compact line suitable for AI prompt"
  artifacts:
    - path: "lib/git-tracker.js"
      provides: "Stateless git progress tracking per project directory"
      exports: ["GitTracker"]
    - path: "lib/resource-monitor.js"
      provides: "System resource data collection"
      exports: ["ResourceMonitor"]
  key_links:
    - from: "lib/git-tracker.js"
      to: "git CLI"
      via: "execSync with git -C"
      pattern: "execSync.*git -C"
    - from: "lib/resource-monitor.js"
      to: "Node.js os module"
      via: "os.loadavg, os.freemem, os.totalmem, os.cpus"
      pattern: "os\\.(loadavg|freemem|totalmem|cpus)"
---

<objective>
Create the two leaf data-collection modules that all other Phase 04 work depends on: GitTracker (git progress per project) and ResourceMonitor (system metrics).

Purpose: These modules provide the raw data that feeds into session evaluation (SESS-02), AI context enrichment (SESS-01, SESS-04), and resume prompts (SESS-03). Building them first unblocks all downstream plans.
Output: Two new files in lib/ -- git-tracker.js and resource-monitor.js -- both independently usable and following the existing DI/class pattern.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-session-intelligence/04-RESEARCH.md
@lib/exec.js
@lib/state.js
@test/helpers.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/git-tracker.js</name>
  <files>lib/git-tracker.js</files>
  <action>
Create a GitTracker class with a single public method:

**getProgress(projectDir, since)**
- `projectDir`: absolute path to project directory
- `since`: optional ISO timestamp string (e.g., "2026-02-17T10:00:00Z") or git date string (e.g., "2 hours ago")
- Returns an object: `{ commitCount, insertions, deletions, filesChanged, fileList, lastCommitHash, lastCommitMessage, lastCommitTimestamp, noGit }`

Implementation details:
1. Wrap ALL git operations in try/catch. If any git command fails (not a git repo, empty repo, etc.), return `{ commitCount: 0, insertions: 0, deletions: 0, filesChanged: 0, fileList: [], lastCommitHash: null, lastCommitMessage: null, lastCommitTimestamp: null, noGit: true }`
2. Use `git -C "${projectDir}" rev-list --count ${sinceArg} HEAD` for commit count. Build sinceArg as `--since="${since}"` only if since is provided.
3. Use `git -C "${projectDir}" log --numstat --format='' ${sinceArg}` for diff stats. Parse tab-delimited lines: `added\tdeleted\tfilename`. Aggregate insertions/deletions, collect unique filenames in a Set. Handle binary files where added/deleted show as `-`.
4. Use `git -C "${projectDir}" log --format='%H|%s|%aI' -1` for last commit metadata. Split on `|` for hash, subject, ISO date. Note: commit messages may contain `|` -- split with limit 3 to handle this.
5. All execSync calls: `{ encoding: 'utf-8', timeout: 5000 }` (10000 for numstat which scans more history).
6. Follow the existing class pattern (no constructor dependencies needed -- this is stateless).

Do NOT:
- Use `--stat` (graph characters, not machine-parseable)
- Throw on git errors (always return noGit sentinel)
- Parse commit messages for semantic meaning (that's the evaluator's job)

Export: `module.exports = GitTracker;`
  </action>
  <verify>
Run `node -e "const GT = require('./lib/git-tracker'); const gt = new GT(); console.log(JSON.stringify(gt.getProgress('$(pwd)')))"` -- should show commit count, insertions, deletions, etc. for this repo.

Run `node -e "const GT = require('./lib/git-tracker'); const gt = new GT(); console.log(JSON.stringify(gt.getProgress('/tmp/not-a-repo')))"` -- should return `{ noGit: true, commitCount: 0, ... }` without throwing.
  </verify>
  <done>
GitTracker.getProgress() returns structured git stats for valid repos and a noGit sentinel for invalid repos, never throwing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create lib/resource-monitor.js</name>
  <files>lib/resource-monitor.js</files>
  <action>
Create a ResourceMonitor class with two public methods:

**getSnapshot()**
- No arguments. Returns an object with system metrics:
  - `cpuLoadAvg1m`: os.loadavg()[0]
  - `cpuLoadAvg5m`: os.loadavg()[1]
  - `cpuCount`: os.cpus().length
  - `freeMemMB`: Math.round(os.freemem() / 1024 / 1024)
  - `totalMemMB`: Math.round(os.totalmem() / 1024 / 1024)
  - `memUsedPct`: Math.round((1 - os.freemem() / os.totalmem()) * 100)
  - `diskUsedPct`: parsed from `df -k / | tail -1`, 5th field (strip `%`). Wrap in try/catch, return null on failure.
  - `uptimeHours`: Math.round(os.uptime() / 3600)

**formatForContext(snapshot)**
- Takes the snapshot object, returns a single compact line for AI context:
  `System: CPU {load1m}/{cpuCount} cores | RAM {freeMemMB}MB free/{totalMemMB}MB ({memUsedPct}% used) | Disk {diskUsedPct}% used | Uptime {uptimeHours}h`
- If diskUsedPct is null, show "Disk N/A"
- Use toFixed(1) for CPU load average

Requires: `const os = require('os')` and `const { execSync } = require('child_process')`.
Follow the existing class pattern in the codebase. No constructor dependencies needed.

Export: `module.exports = ResourceMonitor;`
  </action>
  <verify>
Run `node -e "const RM = require('./lib/resource-monitor'); const rm = new RM(); const s = rm.getSnapshot(); console.log(s); console.log(rm.formatForContext(s))"` -- should show system metrics and a formatted context line.
  </verify>
  <done>
ResourceMonitor.getSnapshot() returns current CPU, memory, disk, and uptime data. formatForContext() produces a compact single-line string.
  </done>
</task>

</tasks>

<verification>
- `node -e "require('./lib/git-tracker')"` loads without error
- `node -e "require('./lib/resource-monitor')"` loads without error
- GitTracker returns valid data for this repo and noGit sentinel for non-repos
- ResourceMonitor returns numeric values for CPU, memory, disk
- No new npm dependencies added
</verification>

<success_criteria>
Both lib/git-tracker.js and lib/resource-monitor.js exist, export classes, load without errors, and return correct structured data when called.
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-intelligence/04-01-SUMMARY.md`
</output>
