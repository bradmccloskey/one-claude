---
phase: 04-session-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - lib/session-manager.js
autonomous: true

must_haves:
  truths:
    - "When a session starts, session.json includes headBefore (the git HEAD commit hash at that moment)"
    - "When a session stops, session.json includes stoppedAt timestamp"
    - "When building a resume prompt, if .orchestrator/evaluation.json exists, the prompt includes the previous session's score, accomplishments, and failures"
  artifacts:
    - path: "lib/session-manager.js"
      provides: "Session lifecycle with evaluation window tracking and eval-informed prompts"
      contains: "headBefore"
  key_links:
    - from: "lib/session-manager.js"
      to: "git CLI"
      via: "execSync git rev-parse HEAD for headBefore"
      pattern: "git.*rev-parse HEAD"
    - from: "lib/session-manager.js"
      to: ".orchestrator/evaluation.json"
      via: "fs.readFileSync in _buildResumePrompt"
      pattern: "evaluation\\.json"
---

<objective>
Modify session-manager.js to (1) capture the git HEAD hash when sessions start (defining the evaluation window), (2) record stoppedAt timestamps, and (3) incorporate previous evaluation data into resume prompts (SESS-03).

Purpose: headBefore + stoppedAt define the exact window for session evaluation. Eval-informed resume prompts let sessions learn from previous attempts, addressing the feedback loop requirement.
Output: Modified lib/session-manager.js with three surgical changes to existing methods.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-session-intelligence/04-RESEARCH.md
@lib/session-manager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add headBefore capture to startSession()</name>
  <files>lib/session-manager.js</files>
  <action>
In the `startSession()` method, BEFORE the session.json write (around line 110), capture the current HEAD commit hash:

```javascript
// Capture HEAD commit hash for evaluation window
let headBefore = null;
try {
  headBefore = execSync(`git -C "${projectDir}" rev-parse HEAD`,
    { encoding: 'utf-8', timeout: 3000 }).trim();
} catch {} // Repo may not exist, have no commits, or not be a git repo
```

Then add `headBefore` to the session.json object that gets written:
```javascript
fs.writeFileSync(
  path.join(signalDir, 'session.json'),
  JSON.stringify({
    projectName,
    sessionName,
    startedAt: new Date().toISOString(),
    headBefore,  // NEW: commit hash at session start for eval window
    prompt: resumePrompt.substring(0, 200),
    status: 'running',
  }, null, 2)
);
```

This is a minimal addition -- do not change anything else in startSession().
  </action>
  <verify>
`grep -n 'headBefore' lib/session-manager.js` shows at least 3 occurrences (declaration, assignment, JSON field).
  </verify>
  <done>
startSession() captures the git HEAD hash and includes it in session.json as headBefore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add stoppedAt timestamp to stopSession() and eval data to _buildResumePrompt()</name>
  <files>lib/session-manager.js</files>
  <action>
**stopSession() change:**
The existing stopSession() already writes `stoppedAt` and `status: 'stopped'` to session.json (lines 151-158). Verify this is present and correct. If it exists, no change needed for stoppedAt. The current code reads:
```javascript
data.status = 'stopped';
data.stoppedAt = new Date().toISOString();
```
This is already correct. No modification needed here.

**_buildResumePrompt() change (SESS-03):**
At the beginning of `_buildResumePrompt()`, before the existing logic, check for a previous evaluation and prepend it to the prompt:

```javascript
_buildResumePrompt(projectName, projectDir) {
  // Check for previous session evaluation (SESS-03)
  let evalContext = '';
  try {
    const evalFile = path.join(projectDir, '.orchestrator', 'evaluation.json');
    if (fs.existsSync(evalFile)) {
      const evalData = JSON.parse(fs.readFileSync(evalFile, 'utf-8'));
      const parts = [
        `Last session scored ${evalData.score}/5 (${evalData.recommendation}).`,
      ];
      if (evalData.accomplishments?.length > 0) {
        parts.push(`Completed: ${evalData.accomplishments.join(', ')}.`);
      }
      if (evalData.failures?.length > 0) {
        parts.push(`Failed: ${evalData.failures.join(', ')}.`);
      }
      parts.push('Continue from where the last session left off.');
      evalContext = parts.join(' ') + '\n\n';
    }
  } catch {} // Eval file may be missing or malformed

  const stateFile = path.join(projectDir, '.planning', 'STATE.md');
  // ... existing logic below, but prepend evalContext to the returned strings
```

Prepend `evalContext` to both return paths (the STATE.md path and the no-state path). For example:
- STATE.md path: `return evalContext + 'Resume work on this project. Read .planning/STATE.md...'`
- No-state path: `return evalContext + \`This is the ${projectName} project...\``

Do NOT:
- Change the stopSession() logic (it already writes stoppedAt)
- Modify startSession() (that was Task 1)
- Add new constructor parameters
- Change the resume prompt content beyond prepending eval context
  </action>
  <verify>
`grep -n 'evaluation.json' lib/session-manager.js` shows the file being read in _buildResumePrompt.
`grep -n 'scored.*5' lib/session-manager.js` shows the eval context format string.
`node -e "require('./lib/session-manager')"` loads without error.
  </verify>
  <done>
Resume prompts include previous evaluation score, accomplishments, and failures when evaluation.json exists. stopSession() already records stoppedAt (verified, no change needed).
  </done>
</task>

</tasks>

<verification>
- `node -e "require('./lib/session-manager')"` loads without error
- `grep 'headBefore' lib/session-manager.js` shows headBefore in startSession
- `grep 'evaluation.json' lib/session-manager.js` shows eval data read in _buildResumePrompt
- No new npm dependencies added
- No changes to stopSession stoppedAt (already present)
</verification>

<success_criteria>
session.json includes headBefore on session start. Resume prompts include previous evaluation context when available. All existing session-manager functionality unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-intelligence/04-03-SUMMARY.md`
</output>
