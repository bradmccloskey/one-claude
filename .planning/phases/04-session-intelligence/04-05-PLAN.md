---
phase: 04-session-intelligence
plan: 05
type: execute
wave: 4
depends_on: ["04-01", "04-02", "04-04"]
files_modified:
  - test/git-tracker.test.js
  - test/session-evaluator.test.js
  - test/resource-monitor.test.js
  - test/helpers.js
autonomous: true

must_haves:
  truths:
    - "Running `node --test 'test/*.test.js'` passes all tests including the three new test files"
    - "GitTracker tests verify getProgress returns correct structure for valid repos and noGit sentinel for invalid paths"
    - "SessionEvaluator tests verify evaluate() returns structured evaluation with score, recommendation, accomplishments, failures"
    - "ResourceMonitor tests verify getSnapshot returns numeric metrics and formatForContext returns a string"
    - "Test helpers include mocks for the new modules (gitTracker, sessionEvaluator, resourceMonitor)"
  artifacts:
    - path: "test/git-tracker.test.js"
      provides: "Tests for GitTracker module"
      contains: "describe.*GitTracker"
    - path: "test/session-evaluator.test.js"
      provides: "Tests for SessionEvaluator module"
      contains: "describe.*SessionEvaluator"
    - path: "test/resource-monitor.test.js"
      provides: "Tests for ResourceMonitor module"
      contains: "describe.*ResourceMonitor"
    - path: "test/helpers.js"
      provides: "Updated mock deps including new modules"
      contains: "gitTracker"
  key_links:
    - from: "test/git-tracker.test.js"
      to: "lib/git-tracker.js"
      via: "require and class instantiation"
      pattern: "require.*git-tracker"
    - from: "test/session-evaluator.test.js"
      to: "lib/session-evaluator.js"
      via: "require and mock-based testing"
      pattern: "require.*session-evaluator"
---

<objective>
Add integration tests for the three new Phase 04 modules, following the established node:test patterns from Phase 03. Update test helpers with mocks for new modules.

Purpose: Tests verify the new modules work correctly and prevent regressions as future phases build on this session intelligence foundation.
Output: Three new test files and updated test/helpers.js.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/git-tracker.js
@lib/session-evaluator.js
@lib/resource-monitor.js
@lib/state.js
@test/helpers.js
@test/exec.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test files for GitTracker and ResourceMonitor</name>
  <files>test/git-tracker.test.js, test/resource-monitor.test.js</files>
  <action>
**test/git-tracker.test.js:**
Use `node:test` and `node:assert` (same pattern as existing tests). Import `{ describe, it }` from `node:test` and `assert` from `node:assert/strict`.

Tests:
1. `getProgress() returns valid structure for current repo` -- call getProgress on the project root (process.cwd() or the project-orchestrator dir). Assert: commitCount >= 1, insertions >= 0, deletions >= 0, filesChanged >= 0, fileList is an array, lastCommitHash is a string of 40 chars, lastCommitTimestamp is a string, noGit is undefined or false.

2. `getProgress() returns noGit sentinel for non-repo directory` -- call getProgress('/tmp'). Assert: noGit === true, commitCount === 0, insertions === 0, deletions === 0, fileList is empty array, lastCommitHash is null.

3. `getProgress() returns noGit sentinel for nonexistent path` -- call getProgress('/tmp/does-not-exist-' + Date.now()). Assert: noGit === true, never throws.

4. `getProgress() with since parameter filters commits` -- call getProgress(projectDir, new Date(Date.now() + 86400000).toISOString()) (future date). Assert: commitCount === 0 (no commits in the future).

**test/resource-monitor.test.js:**
Tests:
1. `getSnapshot() returns system metrics` -- call getSnapshot(). Assert: cpuLoadAvg1m is a number, cpuCount >= 1, freeMemMB > 0, totalMemMB > 0, memUsedPct >= 0 && memUsedPct <= 100, uptimeHours >= 0. diskUsedPct is either null or a number between 0 and 100.

2. `formatForContext() returns formatted string` -- call getSnapshot() then formatForContext(). Assert: result is a string, starts with 'System:', contains 'CPU', contains 'RAM', contains 'Disk', contains 'Uptime'.

3. `formatForContext() handles null diskUsedPct` -- call formatForContext with a snapshot where diskUsedPct is null. Assert: result contains 'Disk N/A'.

Do NOT:
- Mock git or os module internals (these are integration tests against real system)
- Use any test framework beyond node:test and node:assert
  </action>
  <verify>
`node --test test/git-tracker.test.js` passes all tests.
`node --test test/resource-monitor.test.js` passes all tests.
  </verify>
  <done>
GitTracker and ResourceMonitor have passing integration tests covering happy path, error handling, and edge cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SessionEvaluator test and update helpers.js</name>
  <files>test/session-evaluator.test.js, test/helpers.js</files>
  <action>
**test/session-evaluator.test.js:**
This test needs to mock claudePWithSemaphore since we don't want actual LLM calls in tests. Use module-level patching or constructor injection patterns.

The SessionEvaluator uses `require('./exec').claudePWithSemaphore` internally. To test without LLM calls:

1. `EVALUATION_SCHEMA is valid JSON` -- parse the schema, assert it has score, recommendation, accomplishments, failures, reasoning in properties.

2. `evaluate() returns structured evaluation with mocked LLM` -- This requires mocking. Create a test that:
   - Creates a GitTracker instance (real, pointing at project-orchestrator dir)
   - Creates a temp dir with .orchestrator/ and a session.json file
   - Creates a mock state with logEvaluation as a spy
   - The tricky part is mocking claudePWithSemaphore. Since SessionEvaluator requires exec.js at runtime, use Node's module cache to replace it:
     ```javascript
     // Patch exec.js module before requiring session-evaluator
     const execModule = require('../lib/exec');
     const origFn = execModule.claudePWithSemaphore;
     execModule.claudePWithSemaphore = async (prompt, options) => {
       return JSON.stringify({
         score: 4,
         recommendation: 'continue',
         accomplishments: ['Added feature X'],
         failures: [],
         reasoning: 'Good progress with 3 commits',
       });
     };
     ```
   - After test, restore: `execModule.claudePWithSemaphore = origFn;`
   - Assert: returned evaluation has score 4, recommendation 'continue', accomplishments length 1
   - Assert: evaluation.json was written to the temp dir
   - Use createTempDir from helpers for isolation, cleanup after

3. `evaluate() returns fallback on LLM error` -- Same setup but mock claudePWithSemaphore to throw. Assert: evaluation still returned (fallback), score is based on commit count.

**test/helpers.js update:**
Add mocks for the three new modules to `createMockDeps()`:
```javascript
gitTracker: {
  getProgress: () => ({
    commitCount: 0, insertions: 0, deletions: 0, filesChanged: 0,
    fileList: [], lastCommitHash: null, lastCommitMessage: null,
    lastCommitTimestamp: null, noGit: false,
  }),
},
resourceMonitor: {
  getSnapshot: () => ({
    cpuLoadAvg1m: 2.0, cpuLoadAvg5m: 1.5, cpuCount: 8,
    freeMemMB: 4096, totalMemMB: 16384, memUsedPct: 75,
    diskUsedPct: 45, uptimeHours: 100,
  }),
  formatForContext: () => 'System: CPU 2.0/8 cores | RAM 4096MB free/16384MB (75% used) | Disk 45% used | Uptime 100h',
},
sessionEvaluator: {
  evaluate: async () => ({
    score: 3, recommendation: 'continue',
    accomplishments: [], failures: [], reasoning: 'mock',
  }),
},
```

Also add `logEvaluation: () => {}` and `getRecentEvaluations: () => []` to the existing `state` mock in createMockDeps.

Do NOT:
- Make actual LLM calls in tests
- Use jest or mocha (node:test only)
- Skip cleanup of temp directories
  </action>
  <verify>
`node --test test/session-evaluator.test.js` passes all tests.
`node --test 'test/*.test.js'` passes ALL tests (existing + new).
  </verify>
  <done>
SessionEvaluator has passing tests with mocked LLM calls. helpers.js includes mocks for all Phase 04 modules. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
- `node --test 'test/*.test.js'` passes ALL tests (6 files: 3 existing + 3 new)
- No test relies on external LLM calls
- Test files follow node:test + node:assert patterns from Phase 03
- helpers.js createMockDeps includes gitTracker, resourceMonitor, sessionEvaluator mocks
</verification>

<success_criteria>
All new modules have passing tests. All existing tests continue to pass. The test suite runs cleanly via `node --test 'test/*.test.js'`.
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-intelligence/04-05-SUMMARY.md`
</output>
