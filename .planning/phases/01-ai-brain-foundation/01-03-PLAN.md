---
phase: 01-ai-brain-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - lib/commands.js
  - index.js
autonomous: true

must_haves:
  truths:
    - "SMS command 'ai on' enables the AI brain and 'ai off' disables it"
    - "SMS command 'ai think' triggers an immediate think cycle and sends results via SMS"
    - "SMS command 'ai status' shows whether AI is enabled, last think time, and recent decision count"
    - "SMS command 'ai explain' shows the last AI decision with reasoning"
    - "SMS command 'ai level' shows current autonomy level (always 'observe' in Phase 1)"
    - "Think cycle runs automatically on thinkIntervalMs timer when AI is enabled"
    - "Think cycle results are sent as SMS notifications in observe mode"
    - "Existing v2.0 commands work identically"
  artifacts:
    - path: "lib/commands.js"
      provides: "AI command routing and handlers"
      contains: "ai on"
    - path: "index.js"
      provides: "AI brain initialization and think cycle timer integration"
      contains: "aiBrain"
  key_links:
    - from: "lib/commands.js"
      to: "lib/ai-brain.js"
      via: "aiBrain.think(), aiBrain.enable(), aiBrain.getStatus()"
      pattern: "aiBrain\\."
    - from: "lib/commands.js"
      to: "lib/decision-executor.js"
      via: "decisionExecutor.formatForSMS()"
      pattern: "decisionExecutor\\."
    - from: "index.js"
      to: "lib/ai-brain.js"
      via: "periodic think cycle via setInterval"
      pattern: "setInterval.*think"
    - from: "index.js"
      to: "lib/context-assembler.js"
      via: "initialization with deps"
      pattern: "ContextAssembler"
    - from: "index.js"
      to: "lib/decision-executor.js"
      via: "initialization and injection into CommandRouter"
      pattern: "DecisionExecutor"
---

<objective>
Wire the AI brain into the orchestrator's command system and main loop. Add all AI-related SMS commands and integrate the periodic think cycle timer.

Purpose: This makes the AI brain accessible to the user. They can enable/disable it, trigger think cycles, inspect decisions, and receive AI recommendations via SMS -- all without touching config files.

Output: Updated lib/commands.js with AI command handlers, updated index.js with AI module initialization and think cycle timer.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ai-brain-foundation/01-01-SUMMARY.md
@.planning/phases/01-ai-brain-foundation/01-02-SUMMARY.md

@index.js
@lib/commands.js
@lib/ai-brain.js
@lib/decision-executor.js
@lib/context-assembler.js
@config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AI commands to lib/commands.js</name>
  <files>lib/commands.js</files>
  <action>
Modify the CommandRouter class to support AI commands. The constructor already takes deps -- add `aiBrain` and `decisionExecutor` to the deps object.

**1. Update constructor:**
Add after existing dep assignments:
```javascript
this.aiBrain = deps.aiBrain;         // may be null if AI not configured
this.decisionExecutor = deps.decisionExecutor;  // may be null
```

**2. Add AI command routing in route() method:**
Insert BEFORE the context-aware shortcuts section (before the "go/continue/do it" regex):

```javascript
// AI commands
if (lower === 'ai on' || lower === 'ai enable') return this._handleAiOn();
if (lower === 'ai off' || lower === 'ai disable') return this._handleAiOff();
if (lower === 'ai status') return this._handleAiStatus();
if (lower === 'ai think' || lower === 'ai go') return this._handleAiThink();
if (lower === 'ai explain' || lower === 'ai last') return this._handleAiExplain();
if (lower === 'ai level') return this._handleAiLevel();
if (lower === 'ai' || lower === 'ai help') return this._handleAiHelp();
```

**3. Implement AI handlers:**

`_handleAiOn()`:
- If `!this.aiBrain` return "AI brain not configured."
- Call `this.aiBrain.enable()`
- Return "AI brain enabled (observe mode). I'll analyze your projects every 5 minutes and send recommendations.\n\nText 'ai think' to trigger now, 'ai off' to disable."

`_handleAiOff()`:
- If `!this.aiBrain` return "AI brain not configured."
- Call `this.aiBrain.disable()`
- Return "AI brain disabled. No more automatic analysis.\n\nText 'ai on' to re-enable."

`_handleAiStatus()`:
- If `!this.aiBrain` return "AI brain not configured."
- Call `const status = this.aiBrain.getStatus()`
- Format and return:
  ```
  AI Brain: [enabled/disabled]
  Mode: [autonomyLevel]
  Last think: [ISO time or "never"]
  Thinking: [yes/no]
  Decisions logged: [count]
  ```

`_handleAiThink()`:
- If `!this.aiBrain` return "AI brain not configured."
- This should trigger an async think and return a preliminary response immediately.
- Since route() is sync, we need to handle this carefully:
  - Return "Thinking... I'll send results shortly."
  - Schedule the actual think to run after the response: `setTimeout(async () => { ... }, 100)`
  - In the timeout: call `await this.aiBrain.think()`, then format results with `this.decisionExecutor.formatForSMS()`, then send via `this.messenger.send()`
- Store a reference to messenger: add `this.messenger = deps.messenger` in constructor

`_handleAiExplain()`:
- If `!this.aiBrain` return "AI brain not configured."
- Call `const decision = this.aiBrain.getLastDecision()`
- If no decision, return "No AI decisions yet. Text 'ai think' to trigger one."
- Format:
  ```
  Last AI decision:
  [timestamp]

  Summary: [summary]

  Recommendations:
  1. [project] -> [action]: [reason]
  ...

  Duration: [duration_ms]ms
  ```

`_handleAiLevel()`:
- Return the current autonomy level from config with explanation:
  ```
  Autonomy: observe

  In observe mode, the AI analyzes projects and sends recommendations via SMS but does NOT take any actions automatically.

  Levels: observe -> cautious -> moderate -> full
  (Higher levels available in future updates)
  ```

`_handleAiHelp()`:
- Return:
  ```
  AI commands:

  ai on/off - enable/disable AI brain
  ai think - trigger analysis now
  ai status - show AI state
  ai explain - show last decision
  ai level - show autonomy level
  ```

**4. Update _handleHelp():**
Add after existing help lines, before the context section:
```javascript
if (this.aiBrain) {
  lines.push("");
  lines.push("AI: ai on/off | think | status | explain | level");
}
```
  </action>
  <verify>
- Verify AI command routing works:
```bash
node -e "
const CR = require('./lib/commands');
const router = new CR({
  scanner: { scanAll: () => [] },
  processMonitor: { checkProjects: () => ({}) },
  digest: { formatMorningDigest: () => 'digest' },
  scheduler: { isQuietTime: () => false },
  sessionManager: { getActiveSessions: () => [] },
  signalProtocol: { scanSignals: () => [] },
  state: { load: () => ({ aiDecisionHistory: [] }) },
  projectNames: [],
  aiBrain: {
    enable: () => {},
    disable: () => {},
    isEnabled: () => false,
    getStatus: () => ({ enabled: false, lastThinkTime: null, thinking: false, autonomyLevel: 'observe' }),
    getLastDecision: () => null
  },
  decisionExecutor: { formatForSMS: () => 'formatted' },
  messenger: { send: () => {} }
});
console.log('ai on:', router.route('ai on').includes('enabled'));
console.log('ai off:', router.route('ai off').includes('disabled'));
console.log('ai status:', router.route('ai status').includes('Brain'));
console.log('ai explain:', router.route('ai explain').includes('No AI decisions'));
console.log('ai level:', router.route('ai level').includes('observe'));
console.log('ai help:', router.route('ai').includes('commands'));
console.log('help has ai:', router.route('help').includes('AI'));
// Verify existing commands still work
console.log('status works:', router.route('status').includes('morning') || router.route('status').length > 0);
console.log('help works:', router.route('help').includes('Commands'));
"
```
All should print true.
  </verify>
  <done>commands.js routes all AI commands (ai on/off/status/think/explain/level/help), handlers return well-formatted SMS responses, existing command routing unchanged</done>
</task>

<task type="auto">
  <name>Task 2: Wire AI modules into index.js main loop</name>
  <files>index.js</files>
  <action>
Modify index.js to initialize and integrate the AI brain modules.

**1. Add imports** (after existing requires):
```javascript
const ContextAssembler = require("./lib/context-assembler");
const AIBrain = require("./lib/ai-brain");
const DecisionExecutor = require("./lib/decision-executor");
```

**2. Initialize AI modules** (after existing module initialization, before CommandRouter):
```javascript
// ── AI Brain (v3.0) ─────────────────────────────────────────────────────────
const contextAssembler = new ContextAssembler({
  scanner,
  sessionManager,
  processMonitor,
  state,
  config: CONFIG,
});

const decisionExecutor = new DecisionExecutor({
  sessionManager,
  messenger,
  config: CONFIG,
});

const aiBrain = new AIBrain({
  contextAssembler,
  decisionExecutor,
  state,
  messenger,
  config: CONFIG,
});
```

**3. Update CommandRouter initialization** to pass AI deps:
Add to the CommandRouter constructor object:
```javascript
aiBrain,
decisionExecutor,
messenger,  // already available in scope
```

**4. Add AI think cycle** (after existing polling loops):
```javascript
// ── AI Think Cycle ────────────────────────────────────────────────────────
let thinkInterval = null;

function startThinkCycle() {
  if (thinkInterval) return;
  const intervalMs = CONFIG.ai?.thinkIntervalMs || 300000;
  thinkInterval = setInterval(async () => {
    if (!aiBrain.isEnabled()) return;
    if (scheduler.isQuietTime()) return;

    try {
      log("AI", "Starting think cycle...");
      const decision = await aiBrain.think();
      if (decision && decision.recommendations?.length > 0) {
        const sms = decisionExecutor.formatForSMS(
          decisionExecutor.evaluate(decision.recommendations),
          decision.summary
        );
        messenger.send(sms);
        log("AI", `Think cycle complete: ${decision.recommendations.length} recommendations`);
      } else {
        log("AI", "Think cycle complete: no recommendations");
      }
    } catch (e) {
      log("AI", `Think cycle error: ${e.message}`);
    }
  }, intervalMs);
  log("AI", `Think cycle scheduled every ${intervalMs / 1000}s`);
}

startThinkCycle();
```

**5. Update startup banner** to show AI status:
After the existing banner lines (before the closing box line), add:
```javascript
console.log(`║  AI:       ${(CONFIG.ai?.enabled ? "enabled (" + CONFIG.ai.autonomyLevel + ")" : "disabled").padEnd(33)}║`);
```

**6. Update graceful shutdown** to clear the think interval:
Add before `process.exit(0)`:
```javascript
if (thinkInterval) clearInterval(thinkInterval);
```

**7. Update the version string** in the banner from "v2.0" to "v3.0".
  </action>
  <verify>
- Verify index.js can be parsed without syntax errors:
```bash
node -c /Users/claude/projects/project-orchestrator/index.js
```
Should print "Syntax OK" or no output (no error).

- Verify all imports resolve:
```bash
node -e "
require('./lib/context-assembler');
require('./lib/ai-brain');
require('./lib/decision-executor');
console.log('All AI modules load OK');
"
```

- Verify the orchestrator starts (briefly) without crashing:
```bash
cd /Users/claude/projects/project-orchestrator && timeout 3 node -e "
const fs = require('fs');
const path = require('path');

// Quick structural check of index.js
const src = fs.readFileSync('index.js', 'utf-8');
console.log('Has ContextAssembler:', src.includes('ContextAssembler'));
console.log('Has AIBrain:', src.includes('AIBrain'));
console.log('Has DecisionExecutor:', src.includes('DecisionExecutor'));
console.log('Has thinkInterval:', src.includes('thinkInterval'));
console.log('Has v3.0:', src.includes('v3.0'));
console.log('Has AI banner:', src.includes('AI:'));
" 2>/dev/null || true
```
All should print true.
  </verify>
  <done>index.js initializes all AI modules, passes them to CommandRouter, runs periodic think cycle on thinkIntervalMs timer, shows AI status in startup banner, version bumped to v3.0, graceful shutdown clears think interval</done>
</task>

</tasks>

<verification>
1. All AI SMS commands respond correctly: ai on, ai off, ai status, ai think, ai explain, ai level, ai help
2. Existing SMS commands (status, start, stop, sessions, help, etc.) work identically
3. Think cycle timer starts on boot but does not fire when ai.enabled is false
4. Think cycle respects quiet hours
5. `ai think` triggers immediate analysis and sends SMS with results
6. Banner shows v3.0 and AI disabled/enabled status
7. Graceful shutdown clears all timers including think interval
8. Zero new npm dependencies
</verification>

<success_criteria>
- User can text "ai on" to enable, "ai think" to get immediate analysis, "ai off" to disable
- Think cycle runs automatically every 5 minutes when enabled (outside quiet hours)
- AI recommendations arrive as clean, actionable SMS messages
- All existing v2.0 commands continue to work without any changes
- The orchestrator boots cleanly with AI modules initialized
- Version string updated to v3.0 in banner
</success_criteria>

<output>
After completion, create `.planning/phases/01-ai-brain-foundation/01-03-SUMMARY.md`
</output>
