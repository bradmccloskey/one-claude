---
phase: 01-ai-brain-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config.json
  - priorities.json
  - lib/context-assembler.js
autonomous: true

must_haves:
  truths:
    - "context-assembler produces a compact text prompt from live project/session state"
    - "priorities.json allows user to block, skip, or focus specific projects"
    - "config.json has an ai section with model, thinkIntervalMs, maxTokens, autonomyLevel"
  artifacts:
    - path: "lib/context-assembler.js"
      provides: "ContextAssembler class that gathers all state into a prompt string"
      exports: ["ContextAssembler"]
    - path: "priorities.json"
      provides: "User override file for project priorities"
      contains: "focus"
    - path: "config.json"
      provides: "AI configuration section"
      contains: "ai"
  key_links:
    - from: "lib/context-assembler.js"
      to: "lib/scanner.js"
      via: "scanAll() to get project states"
      pattern: "scanner\\.scanAll"
    - from: "lib/context-assembler.js"
      to: "lib/session-manager.js"
      via: "getActiveSessions() for running session info"
      pattern: "sessionManager\\.getActiveSessions"
    - from: "lib/context-assembler.js"
      to: "priorities.json"
      via: "fs.readFileSync to load user overrides"
      pattern: "priorities\\.json"
---

<objective>
Create the foundation layer for AI decision-making: configuration, user priority overrides, and the context assembly module that gathers all project/session state into a compact prompt suitable for `claude -p`.

Purpose: The context assembler is the AI brain's eyes -- it sees everything the orchestrator knows and compresses it into a prompt. Without accurate context, the AI cannot make sensible decisions.

Output: Three artifacts -- updated config.json with AI settings, priorities.json for user overrides, and lib/context-assembler.js that produces prompt strings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@config.json
@lib/scanner.js
@lib/session-manager.js
@lib/process-monitor.js
@lib/state.js
@lib/digest.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AI config section and create priorities.json</name>
  <files>config.json, priorities.json</files>
  <action>
1. Edit `config.json` to add an `ai` section at the top level (after existing fields):

```json
"ai": {
  "enabled": false,
  "model": "sonnet",
  "thinkIntervalMs": 300000,
  "maxPromptLength": 8000,
  "autonomyLevel": "observe",
  "protectedProjects": [],
  "cooldowns": {
    "sameProjectMs": 600000,
    "sameActionMs": 300000
  },
  "resourceLimits": {
    "minFreeMemoryMB": 2048,
    "maxConcurrentThinks": 1
  }
}
```

Fields:
- `enabled`: master switch, default false (user turns on via SMS `ai on`)
- `model`: which model to pass to `claude -p --model`, default "sonnet"
- `thinkIntervalMs`: how often the think cycle runs (5 minutes = 300000)
- `maxPromptLength`: max chars for the assembled context prompt
- `autonomyLevel`: "observe" (Phase 1 only recommends), future: "cautious", "moderate", "full"
- `protectedProjects`: array of project names the AI must never touch
- `cooldowns`: prevent spamming same project/action
- `resourceLimits`: RAM floor and concurrency cap for think cycles

2. Create `priorities.json` in the project root:

```json
{
  "focus": [],
  "block": [],
  "skip": [],
  "notes": {}
}
```

Fields:
- `focus`: array of project names to prioritize (AI should work on these first)
- `block`: array of project names the AI must never start sessions for
- `skip`: array of project names to exclude from AI analysis entirely
- `notes`: object of projectName -> string with human context (e.g., "waiting on Apple cert")

This file is hand-editable by the user and read by context-assembler. It should be `.gitignore`d since it's runtime state.

3. Add `priorities.json` to `.gitignore` (create if needed, or append).
  </action>
  <verify>
- `node -e "const c = require('./config.json'); console.log(c.ai.model, c.ai.autonomyLevel)"` prints "sonnet observe"
- `node -e "const p = require('./priorities.json'); console.log(Object.keys(p).sort().join(','))"` prints "block,focus,notes,skip"
- `grep priorities.json .gitignore` finds a match
  </verify>
  <done>config.json has ai section with all required fields, priorities.json exists with correct schema, priorities.json is gitignored</done>
</task>

<task type="auto">
  <name>Task 2: Create lib/context-assembler.js</name>
  <files>lib/context-assembler.js</files>
  <action>
Create `lib/context-assembler.js` as a CommonJS module exporting a `ContextAssembler` class.

Constructor takes: `{ scanner, sessionManager, processMonitor, state, config }`

Primary method: `assemble()` returns a string (the prompt for claude -p).

The assembled context must include:

1. **System preamble** (hardcoded): Tell the AI its role -- "You are the AI brain of a project orchestrator managing N projects on a Mac Mini. You observe project states and recommend actions. Respond with a JSON object."

2. **Current time + quiet hours status**: Include ISO timestamp and whether quiet hours are active (from config).

3. **User priorities** (from priorities.json): Load priorities.json via `fs.readFileSync` with try/catch fallback to empty defaults. Include focus/block/skip lists and any notes.

4. **Active sessions**: Call `sessionManager.getActiveSessions()` to get running sessions with project names and start times. Include count vs maxConcurrent.

5. **Project states**: Call `scanner.scanAll()` to get all projects. For each project, include: name, status, phase/totalPhases, progress%, blockers, needsAttention flag, attentionReason, lastActivity. Skip projects in the `skip` list from priorities.

6. **Recent decision history**: Load from `state.load().aiDecisionHistory` (array, take last 5). Include so the AI avoids repeating itself.

7. **Response format instructions**: Tell the AI to respond with JSON:
```json
{
  "recommendations": [
    {
      "project": "project-name",
      "action": "start|stop|restart|notify|skip",
      "reason": "why this action",
      "priority": 1-5,
      "message": "SMS text if notify"
    }
  ],
  "summary": "One-line overall assessment",
  "nextThinkIn": "suggested seconds until next think cycle"
}
```

Implementation notes:
- Use `fs.readFileSync` for priorities.json (sync is fine, called infrequently)
- Truncate the total output to `config.ai.maxPromptLength` chars if it exceeds
- Omit projects with no state AND no active session (reduce noise)
- Sort projects: focus first, then needsAttention, then by name
- Format as clean readable text sections separated by `---`, NOT as JSON (easier for the LLM to parse natural language context)
- Each project block should be compact: 2-3 lines max
- Include the count of total projects, active sessions, and projects needing attention at the top as a quick summary

The class should also expose a helper `getProjectSummary(projectName)` that returns a single project's context string (used by `ai explain` command later).
  </action>
  <verify>
- `node -e "const CA = require('./lib/context-assembler'); console.log(typeof CA)"` prints "function"
- Create a quick smoke test inline:
```bash
node -e "
const CA = require('./lib/context-assembler');
// Mock deps
const ca = new CA({
  scanner: { scanAll: () => [{ name: 'test', hasState: true, status: 'in progress', phase: 1, totalPhases: 3, progress: 33, blockers: [], needsAttention: false, lastActivity: '2026-02-16' }] },
  sessionManager: { getActiveSessions: () => [] },
  processMonitor: { checkProjects: () => ({}) },
  state: { load: () => ({ aiDecisionHistory: [] }) },
  config: require('./config.json')
});
const prompt = ca.assemble();
console.log('Length:', prompt.length);
console.log('Has JSON format:', prompt.includes('recommendations'));
console.log('Has project:', prompt.includes('test'));
"
```
All three checks should print true/positive.
  </verify>
  <done>context-assembler.js exports ContextAssembler class, assemble() returns a prompt string containing project states, priorities, session info, decision history, and JSON response format instructions</done>
</task>

</tasks>

<verification>
1. `node -e "require('./config.json').ai.enabled"` returns false (default off)
2. `node -e "require('./priorities.json').focus"` returns [] (empty array)
3. `node -e "new (require('./lib/context-assembler'))({scanner:{scanAll:()=>[]},sessionManager:{getActiveSessions:()=>[]},processMonitor:{},state:{load:()=>({})},config:require('./config.json')}).assemble().length > 100"` returns true
4. No changes to any existing lib/ module behavior
5. `node index.js` still starts without error (AI disabled by default)
</verification>

<success_criteria>
- config.json has complete ai section with sensible defaults
- priorities.json exists and is gitignored
- context-assembler.js produces a complete, well-structured prompt from mock data
- Zero new npm dependencies
- Existing orchestrator functionality unaffected (ai.enabled defaults to false)
</success_criteria>

<output>
After completion, create `.planning/phases/01-ai-brain-foundation/01-01-SUMMARY.md`
</output>
