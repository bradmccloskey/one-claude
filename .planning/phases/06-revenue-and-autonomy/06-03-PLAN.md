---
phase: 06-revenue-and-autonomy
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - lib/context-assembler.js
  - index.js
  - test/helpers.js
autonomous: true

must_haves:
  truths:
    - "context-assembler.js constructor accepts revenueTracker and trustTracker as optional dependencies"
    - "context-assembler.js assemble() includes a revenue section between health and priorities sections"
    - "context-assembler.js assemble() includes a trust metrics section after the revenue section"
    - "_buildRevenueSection() calls revenueTracker.formatForContext() with null-check guard"
    - "_buildTrustSection() calls trustTracker.formatForContext() with null-check guard"
    - "index.js creates RevenueTracker and TrustTracker instances and passes them to ContextAssembler"
    - "index.js scan interval calls revenueTracker.collect() every N scans based on config.revenue.collectionIntervalScans"
    - "index.js scan interval calls trustTracker.update() on every scan cycle"
    - "index.js adds daily promotion check that calls trustTracker.checkPromotion() and sends recommendation via notificationManager"
    - "index.js shutdown function calls revenueTracker.close() and trustTracker.close()"
    - "test/helpers.js createMockDeps includes revenueTracker and trustTracker mocks"
  artifacts:
    - path: "lib/context-assembler.js"
      provides: "AI context with revenue and trust sections"
      contains: "_buildRevenueSection"
    - path: "index.js"
      provides: "Revenue and trust tracker initialization and wiring"
      contains: "RevenueTracker"
    - path: "test/helpers.js"
      provides: "Updated mock deps with revenueTracker and trustTracker"
      contains: "revenueTracker"
  key_links:
    - from: "lib/context-assembler.js"
      to: "lib/revenue-tracker.js"
      via: "revenueTracker.formatForContext()"
      pattern: "revenueTracker"
    - from: "lib/context-assembler.js"
      to: "lib/trust-tracker.js"
      via: "trustTracker.formatForContext()"
      pattern: "trustTracker"
    - from: "index.js"
      to: "lib/revenue-tracker.js"
      via: "require and constructor call"
      pattern: "require.*revenue-tracker"
    - from: "index.js"
      to: "lib/trust-tracker.js"
      via: "require and constructor call"
      pattern: "require.*trust-tracker"
---

<objective>
Wire the RevenueTracker and TrustTracker into the context assembler and main orchestrator loop. Add revenue and trust sections to the AI context prompt, call collection and update methods on the scan interval, add daily promotion checking, and update test helpers with mocks.

Purpose: This is the integration plan that connects the data collection modules (06-01, 06-02) to the AI brain and main loop. After this plan, the AI brain sees revenue and trust data in its context, and the system collects data and checks promotions automatically.
Output: Updated context-assembler.js, index.js, and test/helpers.js.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-revenue-and-autonomy/06-RESEARCH.md
@lib/context-assembler.js
@lib/revenue-tracker.js
@lib/trust-tracker.js
@lib/notification-manager.js
@lib/scheduler.js
@config.json
@index.js
@test/helpers.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add revenue and trust sections to context-assembler.js</name>
  <files>lib/context-assembler.js</files>
  <action>
Update ContextAssembler to accept and use `revenueTracker` and `trustTracker` dependencies.

1. **Constructor**: Add `revenueTracker` and `trustTracker` to the destructured constructor parameter (alongside existing deps). Store as `this.revenueTracker = revenueTracker;` and `this.trustTracker = trustTracker;`.

2. **assemble()**: Add two new sections. After the health section (2.7) and before the priorities section (3):

```javascript
// 2.8. Revenue data
const revenueSection = this._buildRevenueSection();
if (revenueSection) sections.push(revenueSection);

// 2.9. Trust metrics
const trustSection = this._buildTrustSection();
if (trustSection) sections.push(trustSection);
```

3. **New method: _buildRevenueSection()**
```javascript
_buildRevenueSection() {
  if (!this.revenueTracker) return null;
  try {
    return this.revenueTracker.formatForContext();
  } catch {
    return 'Revenue: data unavailable';
  }
}
```

4. **New method: _buildTrustSection()**
```javascript
_buildTrustSection() {
  if (!this.trustTracker) return null;
  try {
    return this.trustTracker.formatForContext();
  } catch {
    return 'Trust Metrics: data unavailable';
  }
}
```

Do NOT:
- Change any existing method signatures or behavior
- Remove any existing sections from assemble()
- Add revenue or trust as required dependencies (they must be optional -- null check)
- Change the constructor signature for existing parameters
  </action>
  <verify>
Run `node -e "const CA = require('./lib/context-assembler'); console.log(typeof CA.prototype._buildRevenueSection, typeof CA.prototype._buildTrustSection)"` -- should print two 'function' strings.
  </verify>
  <done>
ContextAssembler accepts revenueTracker and trustTracker as optional dependencies and includes revenue and trust sections in the AI context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire revenue and trust trackers into index.js</name>
  <files>index.js</files>
  <action>
Update the main orchestrator entry point to initialize and use both new modules.

1. **Add requires** near the top with the other module requires (after HealthMonitor require):
```javascript
const RevenueTracker = require('./lib/revenue-tracker');
const TrustTracker = require('./lib/trust-tracker');
```

2. **Initialize modules** after healthMonitor initialization and before contextAssembler:
```javascript
// -- Revenue Tracker (v4.0 Phase 06) -----------------------------------------
const revenueTracker = new RevenueTracker({ config: CONFIG });

// -- Trust Tracker (v4.0 Phase 06) --------------------------------------------
const trustTracker = new TrustTracker({ config: CONFIG, state });
```

3. **Pass to ContextAssembler** -- add `revenueTracker` and `trustTracker` to the ContextAssembler constructor call:
```javascript
const contextAssembler = new ContextAssembler({
  scanner,
  sessionManager,
  processMonitor,
  state,
  config: CONFIG,
  resourceMonitor,
  healthMonitor,
  revenueTracker,
  trustTracker,
});
```

4. **Add collection to scan interval** -- update the scan interval callback. Add a scan counter and conditionally call collect(). Add trustTracker.update() on every scan:
```javascript
let scanCount = 0;
const scanInterval = setInterval(() => {
  scanCount++;
  proactiveScan();
  checkSessionTimeouts();
  healthMonitor.checkAll();

  // Revenue collection every N scans (default 5 = every 5 minutes)
  const collectionInterval = CONFIG.revenue?.collectionIntervalScans || 5;
  if (CONFIG.revenue?.enabled && scanCount % collectionInterval === 0) {
    revenueTracker.collect().catch(e => log('REVENUE', `Collection error: ${e.message}`));
  }

  // Trust metrics update every scan
  if (CONFIG.trust?.enabled) {
    try { trustTracker.update(); } catch (e) { log('TRUST', `Update error: ${e.message}`); }
  }
}, CONFIG.scanIntervalMs);
```

5. **Add daily promotion check via scheduler** -- after `scheduler.startMorningDigest(sendDigest);`, add a daily promotion check using node-cron:
```javascript
// Daily trust promotion check (10 AM)
if (CONFIG.trust?.enabled) {
  const promotionJob = require('node-cron').schedule(
    CONFIG.trust.promotionCheckCron || '0 10 * * *',
    () => {
      try {
        const recommendation = trustTracker.checkPromotion();
        if (recommendation) {
          notificationManager.notify(recommendation, 2); // tier 2 = action needed
          log('TRUST', `Promotion recommendation sent`);
        }
      } catch (e) {
        log('TRUST', `Promotion check error: ${e.message}`);
      }
    },
    { timezone: CONFIG.quietHours?.timezone || 'America/New_York' }
  );
}
```

6. **Update startup banner** -- add revenue and trust status lines to the startup banner, after the health line:
```javascript
console.log(`\u2551  Revenue:  ${(CONFIG.revenue?.enabled ? 'enabled' : 'disabled').padEnd(33)}\u2551`);
console.log(`\u2551  Trust:    ${(CONFIG.trust?.enabled ? 'enabled' : 'disabled').padEnd(33)}\u2551`);
```

7. **Update shutdown function** -- add cleanup for the new modules before `process.exit(0)`:
```javascript
revenueTracker.close();
trustTracker.close();
```

Do NOT:
- Change the existing scan interval timing or behavior
- Remove any existing functionality from the scan interval callback
- Change the morning digest cron schedule
- Start revenue collection immediately on boot (let scan cycle handle it)
  </action>
  <verify>
Run `node -e "const src = require('fs').readFileSync('./index.js','utf-8'); console.log(src.includes('RevenueTracker'), src.includes('TrustTracker'), src.includes('revenueTracker.collect'), src.includes('trustTracker.update'))"` -- should print four 'true' values.
  </verify>
  <done>
index.js initializes RevenueTracker and TrustTracker, passes them to ContextAssembler, calls collect/update in the scan loop, checks promotions daily, and closes databases on shutdown.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update test/helpers.js with new mocks</name>
  <files>test/helpers.js</files>
  <action>
Add mocks for revenueTracker and trustTracker to `createMockDeps()`. Add them after the existing mcpBridge mock:

```javascript
revenueTracker: {
  collect: async () => {},
  getLatest: () => ({ 'xmr-mining': null, 'mlx-api': null }),
  formatForContext: () => 'Revenue: all mocked',
  getWeeklyTrend: () => ({ thisWeek: { xmr: null, mlx: null }, lastWeek: { xmr: null, mlx: null } }),
  close: () => {},
},
trustTracker: {
  update: () => {},
  checkPromotion: () => null,
  formatForContext: () => 'Trust Metrics: all mocked',
  getMetrics: () => ({ level: 'observe', sessions: 0, avgScore: 0, days: 0, promotionProgress: null }),
  resetPromotionFlag: () => {},
  close: () => {},
},
```

Do NOT remove any existing mock entries.
  </action>
  <verify>
Run `node -e "const { createMockDeps } = require('./test/helpers'); const d = createMockDeps(); console.log(typeof d.revenueTracker.collect, typeof d.trustTracker.update)"` -- should print two 'function' strings.
  </verify>
  <done>
test/helpers.js includes mocks for revenueTracker and trustTracker, maintaining backward compatibility with all existing tests.
  </done>
</task>

</tasks>

<verification>
- `node -e "require('./lib/context-assembler')"` loads without error
- `node -e "const { createMockDeps } = require('./test/helpers'); const d = createMockDeps(); console.log(d.revenueTracker !== undefined, d.trustTracker !== undefined)"` prints "true true"
- ContextAssembler._buildRevenueSection returns null when revenueTracker is not provided
- ContextAssembler._buildTrustSection returns null when trustTracker is not provided
- index.js includes RevenueTracker and TrustTracker require statements
- index.js scan loop calls revenueTracker.collect() conditionally and trustTracker.update()
- index.js shutdown calls close() on both trackers
- No new npm dependencies added
</verification>

<success_criteria>
Revenue and trust data flows from collectors into the AI context. The scan loop collects revenue data every 5 minutes and updates trust metrics every 60 seconds. Daily promotion checks run at 10 AM. Both databases are closed on shutdown. All existing functionality preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/06-revenue-and-autonomy/06-03-SUMMARY.md`
</output>
