---
milestone: v4.0
audited: 2026-02-17
status: gaps_found
scores:
  requirements: 22/22
  phases: 7/7
  integration: 16/19
  flows: 7/10
gaps:
  critical:
    - "ai level <x> command unreachable when AI enabled — autonomy level cannot be changed via SMS"
    - "TrustTracker.resetPromotionFlag never called on level change — promotions stuck after first"
    - "Evening digest reports 0 commits — gitTracker.getProgress(dir, 24) should be '24 hours ago'"
  non_critical:
    - "MCPBridge never instantiated in index.js — MCP capabilities not in AI brain context"
    - "NL handler JSON-strip pattern doesn't match actual context text — wastes ~2000 tokens"
    - "NL handler prompt promises file reading but maxTurns=1 prevents tool use"
    - "HealthMonitor state.logHealthRestart() never called — restart history always empty"
---

# v4.0 Milestone Audit — Project Orchestrator

**Milestone:** v4.0 Autonomous Agent with External Integrations
**Audited:** 2026-02-17
**Status:** gaps_found (3 critical, 4 non-critical)

## Requirements Coverage

All 22 requirements marked Complete. Code exists for every requirement, but 3 have integration-level defects that degrade functionality.

| Category | Requirements | Status |
|----------|-------------|--------|
| Foundation Hardening | FOUND-01 — FOUND-06 | 6/6 Complete |
| Session Intelligence | SESS-01 — SESS-04 | 4/4 Complete |
| Infrastructure Monitoring | INFRA-01 — INFRA-03 | 3/3 Complete |
| Revenue & Autonomy | REV-01 — REV-05 | 5/5 Complete (REV-05 degraded: evening digest shows 0 commits) |
| Personal Assistant | PA-01 — PA-04 | 4/4 Complete |

## Phase Verification

| Phase | Status | Score |
|-------|--------|-------|
| 01 AI Brain Foundation | Passed | 17/17 |
| 02 Autonomous Execution | Passed | 21/21 |
| 03 Foundation Hardening | Passed | 12/12 |
| 04 Session Intelligence | Passed | 4/4 |
| 05 Infrastructure Monitoring | Passed | 23/23 |
| 06 Revenue & Autonomy | Passed | 5/5 |
| 07 Personal Assistant | Passed (after TDZ fix) | 4/4 |

## Critical Gaps

### 1. `ai level` command unreachable when AI is enabled

**Location:** `lib/commands.js` route() lines 52-65
**Impact:** When AI is on (default), texting `ai level moderate` goes through NL handler, which answers conversationally but NEVER calls `state.setAutonomyLevel()`. Autonomy level cannot be changed via SMS.
**Fix:** Extract `ai <subcommand>` prefix checks before the NL fallthrough.

### 2. TrustTracker.resetPromotionFlag never called on level change

**Location:** `lib/commands.js` _handleAiLevel() — no trustTracker reference
**Impact:** After first promotion recommendation, `_promotionSent` stays true forever. No further promotion recommendations until process restart.
**Fix:** Pass trustTracker to CommandRouter, call `resetPromotionFlag()` in `_handleAiLevel()`.

### 3. Evening digest reports 0 commits

**Location:** `index.js` sendEveningDigest() line ~192
**Code:** `gitTracker.getProgress(projectDir, 24)` — numeric 24 is not a valid git --since value
**Impact:** Every evening digest says "Commits today: None" regardless of actual commits.
**Fix:** Change to `gitTracker.getProgress(projectDir, '24 hours ago')`.

## Non-Critical Gaps

### 4. MCPBridge never instantiated in index.js

MCPBridge class exists (`lib/mcp-bridge.js`) with `queryMCP()` and circuit breakers, but is never imported or instantiated in `index.js`. The AI brain context never includes MCP capability information. Session resume prompts DO reference `MCPBridge.KNOWN_SERVERS` transiently via `require()`, but the runtime instance with circuit breaker state doesn't exist.

### 5. NL handler JSON-strip pattern mismatch

`commands.js` searches for `'Respond with a JSON object'` but actual context contains `'Response format is enforced by JSON schema'`. Strip never fires, sending ~2000 extra tokens of conflicting JSON schema instructions to the NL model.

### 6. NL handler maxTurns=1 prevents file reading

Prompt says "You have full permission to read any file" but `maxTurns: 1` prevents any tool calls (tool call = turn 1, result = turn 2, response = turn 3).

### 7. HealthMonitor restart logging not wired

`state.logHealthRestart()` exists and is tested, but `health-monitor.js _restartService()` never calls it. Restart history in state.json is always empty. Auto-restart safety (budget tracking) still works via in-memory array.

## Shared SQLite Integration

All 5 modules sharing `orchestrator.db` are properly integrated:
- No table name conflicts: `revenue_snapshots`, `trust_summary`, `reminders`, `conversations`, `session_evaluations`
- All use WAL mode
- All lazy-init correctly
- All `close()` called on shutdown

## E2E Flow Status

| Flow | Status | Issue |
|------|--------|-------|
| SMS → NL → AI → reminder → reply | Working | |
| SMS → `ai level` → autonomy change | **BROKEN** | NL swallows command |
| Scan → AI think → decision → session | Working | |
| Session stop → eval → learning → context | Working | |
| Health check → failure → alert | Working | |
| Health check → auto-restart → verify | Working | restart not logged to state |
| Revenue collect → context → AI | Working | |
| Trust update → promotion → SMS | **BROKEN at reset** | Flag never resets |
| Evening digest → commit summary | **BROKEN** | 0 commits always |
| Session → resume prompt + MCP + eval | Working | |

## Test Suite

184 tests passing across 14 test files (~206ms).

## Recommendation

Fix the 3 critical gaps before completing the milestone. They affect core functionality:
1. Autonomy level management (the foundation of the trust system)
2. Promotion lifecycle (trust system cannot advance levels)
3. Evening digest accuracy (daily user-facing report)

The 4 non-critical items can be tracked as tech debt for v5.0.
